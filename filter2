# Exim filter

# Unless it is a control message and sent by an authorised user and on
# a safe connection
if
not ( $h_subject: matches "^ *[!]" and
      ( $sender_address_local_part: is "root" or 
        $sender_host_address: is "127.0.0.1" or
      	$sender_host_authenticated: is not ""    ) )
then
  # route to recipients
  deliver "$acl_m_known_alias"
endif

if $h_subject: matches "^ *[!] *on *$"
then 
  # set counter -1
  add ${lookup sqlite{DISP_ALIASES_DB \
        update counters \
        set counter = -1 \
        where prefix = "${quote_sqlite:$acl_m_local_part_prefix_sans}" \
        and stem = "${quote_sqlite:$acl_m_local_part_stem}"} \
        {$value}{-1}} \
  to n1
  seen mail subject "tuned on"

else if $h_subject: matches "^ *[!] *off *$"
then
  # set counter 0
  add ${lookup sqlite{DISP_ALIASES_DB \
        update counters \
        set counter = 0 \
        where prefix = "${quote_sqlite:$acl_m_local_part_prefix_sans}" \
        and stem = "${quote_sqlite:$acl_m_local_part_stem}"} \
        {$value}{-1}} \
  to n1
  seen mail subject "turned off"
else if $h_subject: matches "^ *[!] *report *$"
then
  # report
  mail to 
  subject "disposable mail report"
  text "${lookup sqlite{DISP_ALIASES_DB \
        select * from counters \
        where prefix = "${quote_sqlite:$acl_m_local_part_prefix_sans}" \
        and stem = "${quote_sqlite:$acl_m_local_part_stem}"} \
        {$value}{-1}} \
  to n1
else
  seen mail subject "unknown command: $h_subject"
endif
