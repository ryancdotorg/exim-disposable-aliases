#!/bin/bash

# requirements
# sqlite3
# exim-daemon-heavy v 4.64 (?) for named acl_m variables

function die() {
    echo $* >&2
    exit 1
}

SCRIPT=$(readlink -f ${BASH_SOURCE[0]})
HERE=$(dirname "$SCRIPT")
EXIM=/etc/exim4
USER=Debian-exim
GROUP=Debian-exim
WRITABLE=0750

# FIXME change this to install instead of link
INSTALL='ln -sf'

SQLITE=sqlite3

DISP_ALIASES_DB=/var/spool/exim4/db/disposable-aliases.db
DISP_ALIASES_CONTROLLER=/usr/bin/disposable-aliases-controller
CHECK_RCPT_LOCAL_ACL_FILE=$EXIM/local_disposable-aliases-include


[ -e "$DISP_ALIASES_DB" ] && die "refusing to overwrite database $DISP_ALIASES_DB"
$SQLITE "$DISP_ALIASES_DB" <"$HERE/schema.sql" || die "failed to install sqlite db"
chown $USER:$GROUP "$DISP_ALIASES_DB"
chmod $WRITABLE "$DISP_ALIASES_DB" 

# FIXME copy exim configs
cat >"$EXIM/conf.d/main/00_local-macros" <<EOF
# This needs to be included before the acl and routers

DISP_ALIASES_DB = $DISP_ALIASES_DB
CHECK_RCPT_LOCAL_ACL_FILE = $CHECK_RCPT_LOCAL_ACL_FILE
DISP_ALIASES_CONTROLLER = "|$DISP_ALIASES_CONTROLLER"
EOF

cat >"$CHECK_RCPT_LOCAL_ACL_FILE" <<EOF
#include the disposable aliases acl
deny !acl = disposable_aliases

EOF

# FIXME s/local-/local_/
$INSTALL "$HERE/acl" "$EXIM/conf.d/acl/10_local-disposable_aliases"

$INSTALL "$HERE/router" "$EXIM/conf.d/router/450_local-disposable_aliases"

INSTALL "$HERE/controller" "$DISP_ALIASES_CONTROLLER"

# FIXME restart
