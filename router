
### router/600_local-config_disposable_aliases
#################################

#------------------

# supplementary aliases which allow arbitrary prefixes, delimited with a '.'
# delivery or rejection is controlled by a sqlite database lookup

# put this in a filter file
# if an alias is not defined, go to next router

# acl
# if the prefix is unseen
#   if it contains a count > 0
#     initialise sqlite to that many-1
#     accept # accept by default
#   else
#     initialise to 0 # reject by default
#     fail # or lookup default failure mode?
#   end
# else # it is known
#   if sqlite lookup count > 0
#     decrement count
#     allow
#   else if sqlite lookup count < 0
#     allow
#   else
#     fail # or lookup default failure mode?
#   end
# end
#     
# 


#

disposable_aliases:
  debug_print = "R: disposable_aliases for $local_part@$domain"
  driver = redirect
  domains = +local_domains
#  allow_filter
  allow_fail
  allow_defer
#  ignore_enotdir
  require_files = DISP_ALIASES_DB
  local_part_prefix = *.
  # FIXME deduplicate this query and components
  data = \
  ${lookup sqlite {DISP_ALIASES_DB \
  select recipients from aliases where stem="${quote_sqlite:${sg{$local_part_prefix}{\N[.]([0-9]+[.])?$\N}{}}}"}}


